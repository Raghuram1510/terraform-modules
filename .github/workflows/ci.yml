name: Terraform Multi-Cloud CI

# Trigger the pipeline on push/PR
on:
  push:
    branches: [main, dev]      # Run on pushes to main or dev
    paths: ['modules/**']       # Only when modules/ directory changes
  pull_request:
    branches: [main]            # Run on PRs targeting main

permissions:
  contents: read
  security-events: write

jobs:
  # ============================================================================
  # JOB 1: Detect which modules changed (smart path detection)
  # ============================================================================
  detect-changes:
    name: Detect Changed Modules
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.detect.outputs.modules }}          # JSON array of changed modules
      has-changes: ${{ steps.detect.outputs.has-changes }}  # Boolean flag
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full git history for comparison

      - name: Detect Changed Modules
        id: detect
        run: |
          # Determine base commit for comparison
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE="${{ github.event.pull_request.base.sha }}"  # PR: compare against base branch
          else
            BASE="HEAD~1"  # Push: compare against previous commit
          fi
          
          # Get all changed files in modules/ directory
          CHANGED_FILES=$(git diff --name-only $BASE HEAD | grep '^modules/' || true)
          
          # Exit early if no module files changed
          if [ -z "$CHANGED_FILES" ]; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "No module changes detected"
            exit 0
          fi
          
          # Extract module directories that contain .tf files
          # Pattern: modules/cloud/module-name/ (e.g., modules/aws/vpc/)
          MODULES=""
          for file in $CHANGED_FILES; do
            # Regex match: modules/[cloud]/[module-name]/
            if [[ $file =~ ^modules/([^/]+)/([^/]+)/ ]]; then
              MODULE_DIR="modules/${BASH_REMATCH[1]}/${BASH_REMATCH[2]}"
              
              # CRITICAL: Only include directories with .tf files
              # This filters out README.md and other non-Terraform files
              if ls $MODULE_DIR/*.tf 1> /dev/null 2>&1; then
                MODULES="$MODULES$MODULE_DIR"$'\n'
              fi
            fi
          done
          
          # Remove duplicates and empty lines
          MODULES=$(echo "$MODULES" | sort -u | grep -v '^$' || true)
          
          if [ -z "$MODULES" ]; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "No Terraform module changes detected"
          else
            # Convert to JSON array for matrix strategy
            MODULES_JSON=$(echo "$MODULES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "modules=$MODULES_JSON" >> $GITHUB_OUTPUT
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "Changed modules:"
            echo "$MODULES"
          fi

  # ============================================================================
  # JOB 2: Format check (runs in parallel for each changed module)
  # ============================================================================
  format:
    name: Terraform Format
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    strategy:
      matrix:
        module: ${{ fromJson(needs.detect-changes.outputs.modules) }}  # Run once per module
    uses: Raghuram1510/github-actions-library/.github/workflows/terraform-fmt.yml@main
    with:
      path: ${{ matrix.module }}  # Pass module path to shared workflow

  # ============================================================================
  # JOB 3: Validation (runs after format passes)
  # ============================================================================
  validate:
    name: Terraform Validate
    needs: [detect-changes, format]  # Wait for both jobs
    if: needs.detect-changes.outputs.has-changes == 'true'
    strategy:
      matrix:
        module: ${{ fromJson(needs.detect-changes.outputs.modules) }}
    uses: Raghuram1510/github-actions-library/.github/workflows/terraform-validate.yml@main
    with:
      path: ${{ matrix.module }}

  # ============================================================================
  # JOB 4: Compliance scanning with Checkov (HIPAA, SOC2, CIS)
  # NEW: Deep compliance validation for healthcare/enterprise standards
  # ============================================================================
  compliance-checkov:
    name: Compliance Scan (Checkov)
    needs: [detect-changes, validate]  # Run after validation passes
    if: needs.detect-changes.outputs.has-changes == 'true'
    strategy:
      matrix:
        module: ${{ fromJson(needs.detect-changes.outputs.modules) }}
    uses: Raghuram1510/github-actions-library/.github/workflows/terraform-checkov.yml@main
    with:
      path: ${{ matrix.module }}
      severity-threshold: 'MEDIUM'     # Report MEDIUM, HIGH, CRITICAL
      frameworks: 'hipaa,soc2,cis'     # Check all three compliance frameworks

  # ============================================================================
  # JOB 5: Security scanning with tfsec (fast security checks)
  # NEW: Runs in parallel with Checkov for comprehensive coverage
  # ============================================================================
  compliance-tfsec:
    name: Security Scan (tfsec)
    needs: [detect-changes, validate]  # Parallel with Checkov
    if: needs.detect-changes.outputs.has-changes == 'true'
    strategy:
      matrix:
        module: ${{ fromJson(needs.detect-changes.outputs.modules) }}
    uses: Raghuram1510/github-actions-library/.github/workflows/terraform-tfsec.yml@main
    with:
      path: ${{ matrix.module }}
      severity: 'MEDIUM'  # Report MEDIUM and above

  # ============================================================================
  # JOB 6: Summary - Generate final compliance report
  # Always runs (even if previous jobs fail) to show results
  # ============================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [format, validate, compliance-checkov, compliance-tfsec]
    if: always()  # Run even if previous jobs failed
    
    steps:
      - name: Generate Summary
        run: |
          # Create markdown summary in GitHub Actions UI
          echo "### Multi-Cloud CI Pipeline Complete ðŸŽ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format | ${{ needs.format.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Checkov (HIPAA/SOC2/CIS) | ${{ needs.compliance-checkov.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| tfsec | ${{ needs.compliance-tfsec.result }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # JOB 7: Cleanup - Remove .terraform directories from workflow
  # ============================================================================
  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: [ci-summary]
    if: always()
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Cleanup Terraform Files
        run: |
          echo "Cleaning up .terraform directories..."
          find . -type d -name ".terraform" -exec rm -rf {} + 2>/dev/null || true
          find . -type f -name ".terraform.lock.hcl" -delete 2>/dev/null || true
          echo "âœ… Cleanup complete!"